name: Task Hygiene

on:
  pull_request:
  push:

permissions:
  contents: read

jobs:
  task-hygiene:
    runs-on: ${{ matrix.os }}
    env:
      GH_TOKEN: ${{ github.token }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: 00 Enforce ObjC3C dependency boundaries (strict fail-fast gate)
        run: python scripts/check_objc3c_dependency_boundaries.py --strict
      - name: 00a ObjC3C dependency boundary triage hint
        if: failure()
        run: |
          echo "::error title=ObjC3C dependency boundary gate failed::Run 'python scripts/check_objc3c_dependency_boundaries.py --strict' locally and follow docs/refactor/objc3c_dependency_violation_playbook.md."
      - name: 00b Enforce M135 direct-LLVM packet/docs contract (fail-closed gate)
        run: npm run check:compiler-closeout:m135
      - name: 00c Enforce M137 lexer token packet/docs contract (fail-closed gate)
        run: npm run check:compiler-closeout:m137
      - name: 00d Enforce M138 parser and AST packet/docs contract (fail-closed gate)
        run: npm run check:compiler-closeout:m138
      - name: 00e Enforce M139 sema pass-manager and diagnostics bus packet/docs contract (fail-closed gate)
        run: npm run check:compiler-closeout:m139
      - name: 00f Enforce M140 frontend-library boundary packet/docs contract (fail-closed gate)
        run: npm run check:compiler-closeout:m140
      - name: 00g Enforce M141 CMake target topology packet/docs contract (fail-closed gate)
        run: npm run check:compiler-closeout:m141
      - name: Install Python tooling dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install jsonschema
      - name: Install Node dependencies
        run: npm install
      - name: 01 Run M20 release-gate integration W2 gate (strict deterministic gate)
        run: npm run check:release-gate-integration:w2:strict
      - name: 02 Check catalog status integrity (strict default)
        run: npm run check:catalog-status-integrity
      - name: 03 Check catalog status integrity diagnostics
        run: npm run check:catalog-status-integrity:diagnostics
      - name: 04 Check catalog status metadata completeness
        run: npm run check:catalog-status-metadata
      - name: 05 Run M41 release-and-scale foundation W5 gate (strict deterministic gate)
        run: npm run check:release-scale-foundation:w5:strict
      - name: 06 Check M02 seed-contract parity (strict deterministic gate)
        run: npm run check:seed-contract:m02:strict
      - name: 07 Run M04 activation preflight parity gate (strict deterministic gate)
        run: npm run check:activation-preflight:m04:strict
      - name: 08 Run bootstrap readiness strict gate (runner + planning hygiene)
        run: npm run check:bootstrap-readiness:strict
      - name: 09 Run repo-root open-blocker audit contract strict gate (runner + checker + evidence artifacts)
        run: npm run check:open-blocker-audit:contract:strict
      - name: 10 Run ObjC3C library-vs-cli parity golden gate (strict deterministic gate)
        run: npm run check:objc3c:library-cli-parity:golden
      - name: 11 Run native lane-E perf/cache/repro gate (windows only)
        if: matrix.os == 'windows-latest'
        run: npm run test:objc3c:lane-e
      - name: 12 Run M222 compatibility+migration contract gate
        run: npm run test:objc3c:m222-compatibility-migration
      - name: 13 Run M223 operator-guides docs+CI parity gate
        run: npm run check:objc3c:m223-operator-guides
      - name: 14 Run M224 integration/release-readiness ABI+version gate
        run: npm run check:objc3c:m224-integration-release-readiness
      - name: 15 Run M225 integration roadmap seeding ABI+version export gate
        run: npm run check:objc3c:m225-roadmap-seeding
      - name: 16 Run M221 GA blocker burn-down integration gate
        run: npm run check:objc3c:m221-ga-blocker-burndown
      - name: 17 Run M220 public-beta triage integration gate
        run: npm run check:objc3c:m220-public-beta-triage
      - name: 18 Run M219 cross-platform parity integration gate
        run: npm run check:objc3c:m219-cross-platform-parity
      - name: 19 Run M218 RC automation and provenance integration gate
        run: npm run check:objc3c:m218-rc-provenance
      - name: 20 Run M217 differential testing integration gate
        run: npm run check:objc3c:m217-differential-parity
      - name: 21 Run M216 conformance suite v1 integration gate
        run: npm run check:objc3c:m216-conformance-suite-v1
      - name: 22 Run M215 SDK/toolchain packaging integration gate
        run: npm run check:objc3c:m215-sdk-packaging
      - name: 23 Run M214 daemonized compiler/watch integration gate
        run: npm run check:objc3c:m214-daemonized-watch

  tooling-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Python test/tooling dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest jsonschema
      - name: 01 Run tooling pytest suite
        run: python -m pytest tests/tooling -q
