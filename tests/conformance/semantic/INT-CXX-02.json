{
  "id": "INT-CXX-02",
  "title": "Diagnose ObjC++ callbacks that let +0 async payloads escape into C++-owned state without retain/copy",
  "feature": "ObjC++ interop for ownership, throws, and async lowering parity",
  "bucket": "semantic",
  "profile": "strict",
  "references": [
    "spec/CONFORMANCE_PROFILE_CHECKLIST.md#e-3-11",
    "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11",
    "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-2-3",
    "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-3",
    "spec/PART_8_SYSTEM_PROGRAMMING_EXTENSIONS.md#part-8-6",
    "spec/PART_12_DIAGNOSTICS_TOOLING_TESTS.md#part-12-3-6"
  ],
  "source": "// RUN: objc3c -x objective-c++ -fobjc-version=3 -fsyntax-only %s\ntypedef enum objc_async_completion_status {\n    OBJC_ASYNC_COMPLETION_SUCCESS = 0,\n    OBJC_ASYNC_COMPLETION_ERROR = 1,\n    OBJC_ASYNC_COMPLETION_CANCELLED = 2\n} objc_async_completion_status_t;\n\ntypedef struct INTCXX02Box {\n    id _Nullable savedResult;\n    id<Error> _Nullable savedError;\n} INTCXX02Box;\n\nvoid intcxx02_async_callback(void * _Nullable context,\n                             objc_async_completion_status_t status,\n                             id _Nullable result,\n                             id<Error> _Nullable error) {\n    INTCXX02Box *box = (INTCXX02Box *)context;\n    box->savedResult = result;\n    box->savedError = error;\n    (void)status;\n}\n",
  "expect": {
    "parse": "accept",
    "diagnostics": [
      {
        "code": "OBJC3-D-INTEROP-ASYNC-CALLBACK-ESCAPE-UNRETAINED",
        "severity": "error",
        "span": {
          "start": { "line": 18, "column": 5 },
          "end": { "line": 18, "column": 30 }
        },
        "message": "ObjC++ callback result payload is +0 and must be retained or copied before escaping callback scope"
      },
      {
        "code": "OBJC3-D-INTEROP-ASYNC-CALLBACK-ESCAPE-UNRETAINED",
        "severity": "error",
        "span": {
          "start": { "line": 19, "column": 5 },
          "end": { "line": 19, "column": 28 }
        },
        "message": "ObjC++ callback error payload is +0 and must be retained or copied before escaping callback scope"
      }
    ]
  }
}
