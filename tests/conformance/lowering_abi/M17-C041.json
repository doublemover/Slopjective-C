{
  "id": "M17-C041",
  "title": "Define deterministic lowering ABI contract slice for argument/result/error ownership and call-shape invariants (issue #2136 / task M17-C041)",
  "feature": "M17 Lane C lowering contract slice determinism for async C-boundary ownership and call-shape fields; issue #2136; task M17-C041; sequence 41; dispatch title: [Compiler][M17][Lane C][M17-C041] Define lowering/ABI contract slice (Contract Definition)",
  "bucket": "lowering_abi",
  "profile": "core",
  "references": [
    "spec/CONFORMANCE_PROFILE_CHECKLIST.md#e-3-11",
    "spec/PART_4_MEMORY_MANAGEMENT_OWNERSHIP.md#part-4-4",
    "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-2-4",
    "spec/LOWERING_AND_RUNTIME_CONTRACTS.md#c-5",
    "spec/LOWERING_AND_RUNTIME_CONTRACTS.md#c-5-2",
    "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2"
  ],
  "source": "// RUN: objc3c -fobjc-version=3 -O0 -fsyntax-only %s\n// RUN: objc3c -fobjc-version=3 -O2 -fsyntax-only %s\ntypedef enum M17C041CompletionStatus {\n    M17C041_STATUS_SUCCESS = 0,\n    M17C041_STATUS_ERROR = 1,\n    M17C041_STATUS_CANCELLED = 2\n} M17C041CompletionStatus;\n\ntypedef void (*M17C041Completion)(\n    void * _Nullable context,\n    M17C041CompletionStatus status,\n    id _Nullable result,\n    id<Error> _Nullable error);\n\nvoid M17c041_export_async(id _Nullable seed,\n                          void * _Nullable context,\n                          M17C041Completion _Nonnull completion);\n\ntypedef struct M17C041Probe {\n    int callbackCount;\n    M17C041CompletionStatus lastStatus;\n    id _Nullable lastResult;\n    id<Error> _Nullable lastError;\n} M17C041Probe;\n\nvoid M17c041_probe_callback(void * _Nullable context,\n                            M17C041CompletionStatus status,\n                            id _Nullable result,\n                            id<Error> _Nullable error) {\n    M17C041Probe *probe = (M17C041Probe *)context;\n    probe->callbackCount = probe->callbackCount + 1;\n    probe->lastStatus = status;\n    probe->lastResult = result;\n    probe->lastError = error;\n}\n\nint M17c041_validate_contract(id seed) {\n    M17C041Probe probe;\n    probe.callbackCount = 0;\n    probe.lastStatus = M17C041_STATUS_CANCELLED;\n    probe.lastResult = nil;\n    probe.lastError = nil;\n\n    M17c041_export_async(seed, &probe, M17c041_probe_callback);\n\n    if (probe.callbackCount != 1) {\n        return -1;\n    }\n    if (probe.lastStatus == M17C041_STATUS_SUCCESS && probe.lastError != nil) {\n        return -1;\n    }\n    if (probe.lastStatus != M17C041_STATUS_SUCCESS && probe.lastResult != nil) {\n        return -1;\n    }\n    return 1;\n}\n",
  "expect": {
    "parse": "accept",
    "diagnostics": [],
    "lowering": {
      "mode_matrix": [
        {
          "name": "debug-o0",
          "flags": [
            "-O0"
          ],
          "abi_requirements": [
            "async C thunk completion uses canonical call-shape order: context, status, result, error",
            "status/result/error correlation is deterministic for success, error, and cancellation outcomes",
            "callback invocation count remains exactly once per lowering dispatch"
          ],
          "runtime_assertions": [
            "M17c041_validate_contract returns 1 for contract-compliant callback ordering and payload mapping",
            "M17c041_validate_contract returns -1 for duplicate callback or status/payload ownership drift"
          ]
        },
        {
          "name": "optimized-o2",
          "flags": [
            "-O2"
          ],
          "abi_requirements": [
            "optimized lowering preserves canonical completion call-shape order from -O0",
            "optimization does not reorder or fold status/result/error transport fields",
            "exactly-once callback contract remains stable under optimization"
          ],
          "runtime_assertions": [
            "M17c041_validate_contract still returns 1 under optimization",
            "negative-path sentinel return (-1) remains reachable for contract drift"
          ]
        }
      ],
      "abi_field_stability": [
        {
          "field_id": "M17_lane_c.async_completion_call_shape",
          "contract_anchor": "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-2-4",
          "table_anchor": "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2",
          "required_shape": "completion callback order is context -> status -> result -> error",
          "must_match_modes": [
            "debug-o0",
            "optimized-o2"
          ]
        },
        {
          "field_id": "M17_lane_c.async_completion_ownership_correlation",
          "contract_anchor": "spec/LOWERING_AND_RUNTIME_CONTRACTS.md#c-5-2",
          "table_anchor": "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2",
          "required_shape": "success status carries result without error and non-success status does not carry success payload",
          "must_match_modes": [
            "debug-o0",
            "optimized-o2"
          ]
        }
      ]
    }
  }
}
