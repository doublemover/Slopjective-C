{
  "id": "M01-C001",
  "title": "Preserve canonical async C-thunk completion ABI parameter ordering across optimization modes",
  "feature": "async C-boundary completion ABI shape stability",
  "bucket": "lowering_abi",
  "profile": "core",
  "references": [
    "spec/CONFORMANCE_PROFILE_CHECKLIST.md#e-3-11",
    "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11",
    "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-2-4",
    "spec/LOWERING_AND_RUNTIME_CONTRACTS.md#c-5",
    "spec/LOWERING_AND_RUNTIME_CONTRACTS.md#c-5-2",
    "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2"
  ],
  "source": "// RUN: objc3c -fobjc-version=3 -O0 -fsyntax-only %s\n// RUN: objc3c -fobjc-version=3 -O2 -fsyntax-only %s\ntypedef enum M01C001CompletionStatus {\n    M01C001_STATUS_SUCCESS = 0,\n    M01C001_STATUS_ERROR = 1,\n    M01C001_STATUS_CANCELLED = 2\n} M01C001CompletionStatus;\n\ntypedef void (*M01C001Completion)(\n    void * _Nullable context,\n    M01C001CompletionStatus status,\n    id _Nullable result,\n    id<Error> _Nullable error);\n\nvoid m01c001_export_async(id _Nullable seed,\n                          void * _Nullable context,\n                          M01C001Completion _Nonnull completion);\n\ntypedef struct M01C001Probe {\n    int callbackCount;\n    M01C001CompletionStatus lastStatus;\n    id _Nullable lastResult;\n    id<Error> _Nullable lastError;\n} M01C001Probe;\n\nvoid m01c001_probe_callback(void * _Nullable context,\n                            M01C001CompletionStatus status,\n                            id _Nullable result,\n                            id<Error> _Nullable error) {\n    M01C001Probe *probe = (M01C001Probe *)context;\n    probe->callbackCount = probe->callbackCount + 1;\n    probe->lastStatus = status;\n    probe->lastResult = result;\n    probe->lastError = error;\n}\n\nint m01c001_check(id seed) {\n    M01C001Probe probe;\n    probe.callbackCount = 0;\n    probe.lastStatus = M01C001_STATUS_CANCELLED;\n    probe.lastResult = nil;\n    probe.lastError = nil;\n\n    m01c001_export_async(seed, &probe, m01c001_probe_callback);\n\n    if (probe.callbackCount != 1) {\n        return -1;\n    }\n    if (probe.lastStatus == M01C001_STATUS_SUCCESS && probe.lastError != nil) {\n        return -1;\n    }\n    if (probe.lastStatus != M01C001_STATUS_SUCCESS && probe.lastResult != nil) {\n        return -1;\n    }\n    return 1;\n}\n",
  "expect": {
    "parse": "accept",
    "diagnostics": [],
    "lowering": {
      "mode_matrix": [
        {
          "name": "debug-o0",
          "flags": [
            "-O0"
          ],
          "abi_requirements": [
            "async C thunk uses canonical completion layout: context, status, result, error",
            "status and payload/error mapping remain deterministic for success/failure/cancelled outcomes",
            "callback invocation count is stable and exactly-once per thunk dispatch"
          ],
          "runtime_assertions": [
            "m01c001_check returns 1 for contract-compliant callback ordering and payload mapping",
            "m01c001_check returns -1 for negative-path outcomes including duplicate callback, success+error, or non-success+payload"
          ]
        },
        {
          "name": "optimized-o2",
          "flags": [
            "-O2"
          ],
          "abi_requirements": [
            "optimized lowering preserves canonical completion parameter ordering from -O0",
            "optimization does not fold or reorder status/result/error fields at async C boundaries",
            "exactly-once completion callback contract remains stable under optimization"
          ],
          "runtime_assertions": [
            "m01c001_check still returns 1 under optimization",
            "negative-path sentinel return (-1) remains reachable for callback/order drift"
          ]
        }
      ],
      "abi_field_stability": [
        {
          "field_id": "interop.async_completion_signature_order",
          "contract_anchor": "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-2-4",
          "table_anchor": "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2",
          "required_shape": "completion callback order is context -> status -> result -> error",
          "must_match_modes": [
            "debug-o0",
            "optimized-o2"
          ]
        },
        {
          "field_id": "interop.async_completion_status_error_correlation",
          "contract_anchor": "spec/LOWERING_AND_RUNTIME_CONTRACTS.md#c-5-2",
          "table_anchor": "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2",
          "required_shape": "success status does not carry error and non-success status does not carry success payload",
          "must_match_modes": [
            "debug-o0",
            "optimized-o2"
          ]
        }
      ]
    }
  }
}
