{
  "id": "M18-C014",
  "title": "Enforce exactly-once cleanup execution on normal and unwind exits for lowering boundary traces (issue #2294 / task M18-C014)",
  "feature": "M18 Lane C cleanup and unwind lowering correctness invariants; issue #2294; task M18-C014; sequence 14; dispatch title: [Compiler][M18][Lane C][M18-C014] Add cleanup/unwind correctness path (Conformance Expansion)",
  "bucket": "lowering_abi",
  "profile": "core",
  "references": [
    "spec/CONFORMANCE_PROFILE_CHECKLIST.md#e-3-5",
    "spec/PART_5_CONTROL_FLOW_SAFETY_CONSTRUCTS.md#part-5-2",
    "spec/PART_8_SYSTEM_PROGRAMMING_EXTENSIONS.md#part-8-2-4",
    "spec/LOWERING_AND_RUNTIME_CONTRACTS.md#c-5-1",
    "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2"
  ],
  "source": "// RUN: objc3c -x objective-c++ -std=c++17 -fobjc-version=3 -fobjc-arc -fexceptions -O0 -fsyntax-only %s\n// RUN: objc3c -x objective-c++ -std=c++17 -fobjc-version=3 -fobjc-arc -fexceptions -O2 -fsyntax-only %s\nint M18c014_normal_trace(void) {\n    int trace = 0;\n    int onceOuter = 0;\n    int onceInner = 0;\n\n    {\n        defer { trace = trace * 10 + 1; onceOuter = onceOuter + 1; };\n        defer { trace = trace * 10 + 2; onceInner = onceInner + 1; };\n        trace = 9;\n    }\n\n    if (onceOuter != 1 || onceInner != 1) {\n        return -1;\n    }\n    return trace;\n}\n\nint M18c014_unwind_trace(void) {\n    int trace = 0;\n    int onceOuter = 0;\n    int onceInner = 0;\n\n    try {\n        defer { trace = trace * 10 + 1; onceOuter = onceOuter + 1; };\n        trace = 9;\n        {\n            defer { trace = trace * 10 + 2; onceInner = onceInner + 1; };\n            throw 404;\n        }\n    } catch (...) {\n        trace = trace * 10 + 7;\n    }\n\n    if (onceOuter != 1 || onceInner != 1) {\n        return -1;\n    }\n    return trace;\n}\n\nint M18c014_validate_cleanup(void) {\n    if (M18c014_normal_trace() != 921) {\n        return -1;\n    }\n    if (M18c014_unwind_trace() != 9217) {\n        return -1;\n    }\n    return 1;\n}\n",
  "expect": {
    "parse": "accept",
    "diagnostics": [],
    "lowering": {
      "mode_matrix": [
        {
          "name": "debug-o0",
          "flags": [
            "-x objective-c++",
            "-fobjc-arc",
            "-fexceptions",
            "-O0"
          ],
          "abi_requirements": [
            "normal-exit cleanup actions execute in reverse registration order and exactly once",
            "unwind cleanup actions execute before catch handler logic and exactly once",
            "cleanup ordering remains deterministic for both normal and unwind boundary exits"
          ],
          "runtime_assertions": [
            "M18c014_normal_trace returns 921 for stable normal-exit cleanup ordering",
            "M18c014_unwind_trace returns 9217 for stable unwind cleanup ordering",
            "M18c014_validate_cleanup returns 1 when both cleanup paths satisfy exactly-once invariants"
          ]
        },
        {
          "name": "optimized-o2",
          "flags": [
            "-x objective-c++",
            "-fobjc-arc",
            "-fexceptions",
            "-O2"
          ],
          "abi_requirements": [
            "optimized lowering preserves normal and unwind cleanup ordering from -O0",
            "optimization does not duplicate or elide registered cleanup actions",
            "cleanup determinism remains stable across replayed optimized builds"
          ],
          "runtime_assertions": [
            "M18c014_validate_cleanup remains 1 under optimization",
            "negative-path sentinel return (-1) remains deterministic for cleanup drift"
          ]
        }
      ],
      "abi_field_stability": [
        {
          "field_id": "cleanup.normal_exit_exactly_once",
          "contract_anchor": "spec/PART_5_CONTROL_FLOW_SAFETY_CONSTRUCTS.md#part-5-2",
          "table_anchor": "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2",
          "stability_property": "normal-exit cleanup registrations execute exactly once in LIFO order",
          "must_match_modes": [
            "debug-o0",
            "optimized-o2"
          ]
        },
        {
          "field_id": "cleanup.unwind_exit_exactly_once",
          "contract_anchor": "spec/PART_8_SYSTEM_PROGRAMMING_EXTENSIONS.md#part-8-2-4",
          "table_anchor": "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2",
          "stability_property": "unwind-exit cleanup registrations execute exactly once before handler logic",
          "must_match_modes": [
            "debug-o0",
            "optimized-o2"
          ]
        }
      ]
    }
  }
}
