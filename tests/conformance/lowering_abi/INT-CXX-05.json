{
  "id": "INT-CXX-05",
  "title": "Preserve ObjC++ ownership boundaries for +0 async callback payloads with parity to ObjC lowering",
  "feature": "ObjC++ interop for ownership, throws, and async lowering parity",
  "bucket": "lowering_abi",
  "profile": "core",
  "references": [
    "spec/CONFORMANCE_PROFILE_CHECKLIST.md#e-3-11",
    "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11",
    "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-2-3",
    "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-2-4",
    "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-3",
    "spec/PART_8_SYSTEM_PROGRAMMING_EXTENSIONS.md#part-8-6",
    "spec/LOWERING_AND_RUNTIME_CONTRACTS.md#c-5",
    "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2"
  ],
  "source": "// RUN: objc3c -x objective-c++ -fobjc-version=3 -O0 -fsyntax-only %s\n// RUN: objc3c -x objective-c++ -fobjc-version=3 -O2 -fsyntax-only %s\ntypedef enum objc_async_completion_status {\n    OBJC_ASYNC_COMPLETION_SUCCESS = 0,\n    OBJC_ASYNC_COMPLETION_ERROR = 1,\n    OBJC_ASYNC_COMPLETION_CANCELLED = 2\n} objc_async_completion_status_t;\n\ntypedef void (*INTCXX05Completion)(\n    void * _Nullable context,\n    objc_async_completion_status_t status,\n    id _Nullable result,\n    id<Error> _Nullable error);\n\nid intcxx05_fetch(int token) async throws;\nvoid intcxx05_fetch_async_c(int token,\n                            void * _Nullable context,\n                            INTCXX05Completion _Nonnull completion);\n\nid intcxx05_retain(id _Nullable value);\nvoid intcxx05_release(id _Nullable value);\n\ntypedef struct INTCXX05Probe {\n    int callbackCount;\n    void * _Nullable echoedContext;\n    id _Nullable retainedResult;\n    id<Error> _Nullable retainedError;\n} INTCXX05Probe;\n\nstruct INTCXX05ScopedHold {\n    INTCXX05Probe *probe;\n    explicit INTCXX05ScopedHold(INTCXX05Probe *p) : probe(p) {}\n    ~INTCXX05ScopedHold() {\n        if (probe->retainedResult != nil) {\n            intcxx05_release(probe->retainedResult);\n        }\n        if (probe->retainedError != nil) {\n            intcxx05_release((id)probe->retainedError);\n        }\n    }\n};\n\nvoid intcxx05_probe_callback(void * _Nullable context,\n                             objc_async_completion_status_t status,\n                             id _Nullable result,\n                             id<Error> _Nullable error) {\n    INTCXX05Probe *probe = (INTCXX05Probe *)context;\n    probe->callbackCount = probe->callbackCount + 1;\n    probe->echoedContext = context;\n    if (status == OBJC_ASYNC_COMPLETION_SUCCESS && result != nil) {\n        probe->retainedResult = intcxx05_retain(result);\n    }\n    if (error != nil) {\n        probe->retainedError = (id<Error>)intcxx05_retain((id)error);\n    }\n}\n\nint intcxx05_start_probe(int token, INTCXX05Probe *probe) {\n    INTCXX05ScopedHold hold(probe);\n    probe->callbackCount = 0;\n    probe->echoedContext = 0;\n    probe->retainedResult = nil;\n    probe->retainedError = nil;\n    intcxx05_fetch_async_c(token, probe, intcxx05_probe_callback);\n    return probe->callbackCount;\n}\n",
  "expect": {
    "parse": "accept",
    "diagnostics": [],
    "lowering": {
      "mode_matrix": [
        {
          "name": "debug-o0",
          "flags": [
            "-O0"
          ],
          "abi_requirements": [
            "ObjC++ async thunk callbacks deliver result and error payloads at +0 ownership, matching ObjC-mode interop rules",
            "delivered +0 values are kept alive for completion dynamic extent so C++ code can retain/copy before callback return",
            "context remains opaque caller-owned state and is forwarded without retain/release side effects",
            "canonical trailing thunk parameters remain context then completion in ObjC++ mode"
          ],
          "runtime_assertions": [
            "intcxx05_probe_callback executes exactly once per intcxx05_fetch_async_c invocation",
            "probe->echoedContext is bitwise-identical to the context pointer supplied by the caller",
            "values retained in callback remain safely consumable after callback return and are releasable via RAII cleanup"
          ]
        },
        {
          "name": "optimized-o2",
          "flags": [
            "-O2"
          ],
          "abi_requirements": [
            "optimized ObjC++ lowering preserves +0 callback ownership and dynamic-extent lifetime guarantees from -O0",
            "optimized ObjC++ lowering preserves caller-owned context pass-through contract",
            "optimization does not alter canonical trailing context/completion thunk ordering"
          ],
          "runtime_assertions": [
            "exactly-once callback delivery remains true under optimization",
            "retained-value post-callback consumption behavior remains equivalent to -O0",
            "context pointer identity remains unchanged under optimization"
          ]
        }
      ],
      "abi_field_stability": [
        {
          "field_id": "interop.objcxx_async_callback_plus0_delivery",
          "contract_anchor": "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-2-3",
          "table_anchor": "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2",
          "required_shape": "result/error payloads are delivered at +0 and valid for completion dynamic extent in ObjC++ mode",
          "must_match_modes": [
            "debug-o0",
            "optimized-o2"
          ]
        },
        {
          "field_id": "interop.objcxx_async_context_nonownership",
          "contract_anchor": "spec/PART_11_INTEROPERABILITY_C_CPP_SWIFT.md#part-11-2-3",
          "table_anchor": "spec/MODULE_METADATA_AND_ABI_TABLES.md#d-3-2",
          "required_shape": "context is caller-owned and passed through unchanged without ownership transfer",
          "must_match_modes": [
            "debug-o0",
            "optimized-o2"
          ]
        }
      ]
    }
  }
}
